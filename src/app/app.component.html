<div class="container" *ngIf="currentState">
  <mat-grid-list cols="2" rowHeight="400px" gutterSize="16px">
    <mat-grid-tile colspan="1" rowspan="2">
      <div class="column-container">
        <mat-card class="state-card">
          <mat-card-header>
            <mat-card-title>
              Estado Actual:
              <span [ngClass]="{
                'sensing': currentState.state === 'SENSING',
                'countdown': currentState.state === 'COUNTDOWN',
                'alarm': currentState.state === 'ALARM',
                'authorized': currentState.state === 'AUTHORIZED'
              }">
                {{currentState.state}}
              </span>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div *ngIf="currentState.message">
              <p>{{currentState.message}}</p>
            </div>

            <div *ngIf="currentState.countdown !== undefined && currentState.countdown >= 0">
              <p>Cuenta regresiva: {{currentState.countdown}}</p>
              <mat-progress-bar
                mode="determinate"
                [value]="countdownProgress"
                [color]="currentState.state === 'COUNTDOWN' ? 'warn' : 'primary'">
              </mat-progress-bar>
            </div>

            <div *ngIf="currentState.uid_status">
              <p>Estado UID: {{currentState.uid_status}}</p>
            </div>

            <button
              mat-raised-button
              color="warn"
              (click)="deactivateAlarm()"
              [disabled]="currentState.state !== 'COUNTDOWN' && currentState.state !== 'ALARM'">
              Desactivar Alarma
            </button>
          </mat-card-content>
        </mat-card>

        <mat-card class="history-card">
          <mat-card-header>
            <mat-card-title>Historial de Estados</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <table mat-table [dataSource]="stateHistory" class="mat-elevation-z1">
              <ng-container matColumnDef="state">
                <th mat-header-cell *matHeaderCellDef>Estado</th>
                <td mat-cell *matCellDef="let item">{{item.state}}</td>
              </ng-container>

              <ng-container matColumnDef="timestamp">
                <th mat-header-cell *matHeaderCellDef>Hora</th>
                <td mat-cell *matCellDef="let item">{{item.timestamp | date:'mediumTime'}}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['state', 'timestamp']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['state', 'timestamp'];"></tr>
            </table>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-grid-tile>

    <mat-grid-tile colspan="1" rowspan="2">
      <mat-card class="messages-card">
        <mat-card-header>
          <mat-card-title>Registro de Eventos</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="allMessages" class="mat-elevation-z1">
            <ng-container matColumnDef="state">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let item">{{item.state}}</td>
            </ng-container>

            <ng-container matColumnDef="message">
              <th mat-header-cell *matHeaderCellDef>Mensaje</th>
              <td mat-cell *matCellDef="let item">{{item.message}}</td>
            </ng-container>

            <ng-container matColumnDef="timestamp">
              <th mat-header-cell *matHeaderCellDef>Hora</th>
              <td mat-cell *matCellDef="let item">{{item.timestamp | date:'mediumTime'}}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['state', 'message', 'timestamp']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['state', 'message', 'timestamp'];"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </mat-grid-tile>
  </mat-grid-list>
</div>

<div *ngIf="!currentState" class="connecting">
  <mat-spinner></mat-spinner>
  <p>Conectando al sistema de alarma...</p>
</div>
